
Runner.pages.PageSettings.addPageEvent('socio',Runner.pages.constants.PAGE_ADD,"afterPageReady",function(pageObj,proxy,pageid,inlineRow,inlineObject,row){if(proxy['cluber']==true){Runner.getControl(pageid,'clube').makeReadonly();}
if(proxy['perfilr']==true){Runner.getControl(pageid,'perfilusu').makeReadonly();};});Runner.pages.PageSettings.addPageEvent('socio',Runner.pages.constants.PAGE_EDIT,"afterPageReady",function(pageObj,proxy,pageid,inlineRow,inlineObject,row){if(proxy['cluber']==true){Runner.getControl(pageid,'clube').makeReadonly();}
if(proxy['perfilr']==true){Runner.getControl(pageid,'perfilusu').makeReadonly();};});Runner.pages.PageSettings.addPageEvent('socio',Runner.pages.constants.PAGE_ADD,"afterPageReady",function(pageObj,proxy,pageid,inlineRow,inlineObject,row){console.log("Evento afterPageReady - Script datavenci carregado!");setTimeout(function(){initDatavenciControl(pageid);},1000);});Runner.pages.PageSettings.addPageEvent('socio',Runner.pages.constants.PAGE_EDIT,"afterPageReady",function(pageObj,proxy,pageid,inlineRow,inlineObject,row){console.log("Evento afterPageReady EDIT - Script datavenci carregado!");setTimeout(function(){initDatavenciControl(pageid);},1000);});Runner.pages.PageSettings.addPageEvent('socio',Runner.pages.constants.PAGE_ADD,"beforeSave",function(pageObj,proxy,pageid,inlineRow,inlineObject,row){console.log("Evento beforeSave - Processando datavenci");processDatavenciBeforeSave(pageid);});Runner.pages.PageSettings.addPageEvent('socio',Runner.pages.constants.PAGE_EDIT,"beforeSave",function(pageObj,proxy,pageid,inlineRow,inlineObject,row){console.log("Evento beforeSave EDIT - Processando datavenci");processDatavenciBeforeSave(pageid);});Runner.pages.fieldsEvents["cep_event"]=function(pageObj,pageid,row){if(row){row=new Runner.AjaxRow(pageObj,row);}
var ret,reqParams,ctrl=this,fieldsData={},params={},ajax=new Runner.form.Button({id:'cep_event',btnName:'cep_event'}),before=function(){params["value"]=this.getValue();},after=function(result){var endereco=ctrl.getPeer("endereco");endereco.setValue(result["endereco"])
var cidade=ctrl.getPeer("cidade");cidade.setValue(result["cidade"]);var bairro=ctrl.getPeer("bairro");bairro.setValue(result["bairro"]);var estado=ctrl.getPeer("estado");estado.setValue(result["estado"]);var pais=ctrl.getPeer("pais");pais.setValue(result["pais"]);},submit=function(){params["table"]="socio";params["field"]=ctrl.fieldName;params.page=pageObj.pageName;(Runner.controls.ControlStorage.byId(pageid)||[]).forEach(function(ctrl){if(!(ctrl instanceof Runner.controls.MultiUploadField)&&!(ctrl instanceof Runner.controls.FileControl)){fieldsData[ctrl.fieldName]=ctrl.getStringValue();}});reqParams={params:JSON.stringify(params),event:"cep_event",pageType:pageObj.pageType,keys:JSON.stringify(pageObj.keys?pageObj.keys:(row&&row.getKeys())),fieldsData:JSON.stringify(fieldsData)};if(pageObj.masterTable){reqParams.masterTable=pageObj.masterTable;reqParams=Runner.apply(reqParams,pageObj.masterKeys);}
$.post(Runner.getPageUrl("buttonhandler"),reqParams,function(result){var _result;try{_result=JSON.parse(result);}catch(e){Runner.displayGenericAjaxError(result);}
after.call(ctrl,_result);}).fail(function(jqXHR,textStatus,errorThrown){Runner.displayGenericAjaxError(jqXHR.responseText||textStatus+' '+errorThrown);});submit=function(){};};ajax.submitHandler=submit;ajax.submit=submit;ret=before.call(this);if(ret===false){return;}
submit();};function initDatavenciControl(pageid){console.log("Iniciando controle de datavenci para pageid:",pageid);$("<style>").prop("type","text/css").html(".datavenci-field{display:none!important}.datavenci-field.show{display:block!important}").appendTo("head");var perfilusuField=Runner.getControl(pageid,"perfilusu");if(!perfilusuField){console.error("Campo perfilusu não encontrado!");setTimeout(function(){initDatavenciControl(pageid);},2000);return;}var datavenciContainer=$("[data-field=\"datavenci\"]");if(datavenciContainer.length===0){datavenciContainer=$(".datavenci-field");}console.log("Container datavenci encontrado:",datavenciContainer.length);if(datavenciContainer.length===0){console.error("Container datavenci não encontrado!");setTimeout(function(){initDatavenciControl(pageid);},2000);return;}function loadDatavenciValue(){var hiddenInput=datavenciContainer.find("input[name*=\"value_datavenci\"]");console.log("Campo oculto encontrado:",hiddenInput.length);console.log("Valor do campo oculto:",hiddenInput.val());if(hiddenInput.length>0&&hiddenInput.val()){var dateValue=hiddenInput.val();console.log("Carregando valor existente datavenci:",dateValue);if(dateValue&&dateValue!=="0000-00-00"&&dateValue!==""){var parts=dateValue.split("-");if(parts.length===3){var year=parts[0];var month=parts[1];var day=parts[2];console.log("Separando data:",year,month,day);var daySelect=datavenciContainer.find("select[name*=\"dayvalue\"]");var monthSelect=datavenciContainer.find("select[name*=\"monthvalue\"]");var yearSelect=datavenciContainer.find("select[name*=\"yearvalue\"]");console.log("Selects encontrados - dia:",daySelect.length,"mes:",monthSelect.length,"ano:",yearSelect.length);if(daySelect.length&&monthSelect.length&&yearSelect.length){daySelect.val(day);monthSelect.val(month);yearSelect.val(year);console.log("Valores carregados nos selects - dia:",day,"mes:",month,"ano:",year);}}}}else{console.log("Nenhum valor existente para carregar");}}function toggleDatavenci(){var perfil=perfilusuField.getValue();console.log("Perfil selecionado:",perfil);if(perfil==="SÓCIO INDIVIDUAL"||perfil==="SOCIO INDIVIDUAL"){console.log("Mostrando campo datavenci");datavenciContainer.removeClass("datavenci-field");datavenciContainer.addClass("show");var label=datavenciContainer.find("label");if(label.length>0){label.addClass("required");}loadDatavenciValue();}else{console.log("Ocultando campo datavenci");datavenciContainer.addClass("datavenci-field");datavenciContainer.removeClass("show");datavenciContainer.find("input, select").val("");var label=datavenciContainer.find("label");if(label.length>0){label.removeClass("required");}}}toggleDatavenci();perfilusuField.on("change",function(){console.log("Perfil alterado!");toggleDatavenci();});console.log("Controle de datavenci inicializado com sucesso!");}function processDatavenciBeforeSave(pageid){console.log("Processando datavenci antes de salvar para pageid:",pageid);var datavenciContainer=$("[data-field=\"datavenci\"]");if(datavenciContainer.length===0){datavenciContainer=$(".datavenci-field");}if(datavenciContainer.length>0){var daySelect=datavenciContainer.find("select[name*=\"dayvalue\"]");var monthSelect=datavenciContainer.find("select[name*=\"monthvalue\"]");var yearSelect=datavenciContainer.find("select[name*=\"yearvalue\"]");var hiddenInput=datavenciContainer.find("input[name*=\"value_datavenci\"]");if(daySelect.length&&monthSelect.length&&yearSelect.length&&hiddenInput.length){var day=daySelect.val();var month=monthSelect.val();var year=yearSelect.val();console.log("Valores da data:",day,month,year);if(day&&month&&year){var formattedDate=year+"-"+month.padStart(2,"0")+"-"+day.padStart(2,"0");console.log("Data formatada:",formattedDate);hiddenInput.val(formattedDate);console.log("Valor do campo oculto atualizado:",hiddenInput.val());}else{hiddenInput.val("");console.log("Campo datavenci limpo");}}}}